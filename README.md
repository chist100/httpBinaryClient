# HTTP Binary Client

HTTP-клиент на Go для потоковой передачи больших файлов через multipart/form-data запросы с отображением прогресса.

## Особенности

- **Потоковая передача**: Файлы передаются по частям, не загружаясь полностью в память
- **Отображение прогресса**: Показывает процент выполнения и количество переданных байт
- **Обработка ошибок**: Детальные сообщения об ошибках на русском языке
- **Поддержка больших файлов**: Оптимизирован для файлов размером до 50 ГБ
- **Юнит-тесты**: Полное покрытие тестами
- **Graceful shutdown**: Корректное завершение работы сервера

## Структура проекта

```
httpBinaryClient/
├── client/          # HTTP-клиент
│   ├── client.go    # Основная логика клиента
│   └── client_test.go # Юнит-тесты
├── server/          # HTTP-сервер
│   └── server.go    # Сервер для тестирования
├── scripts/         # Скрипты для генерации тестовых файлов
│   └── generate_binary_file.go # Генерация бинарных файлов
├── test_files/      # Каталог для тестовых файлов
├── main.go          # Основная программа
├── go.mod           # Зависимости Go
├── task.txt         # Техническое задание
└── README.md        # Документация
```

## Генерация бинарных тестовых файлов

Для тестирования передачи больших файлов используйте скрипт генерации бинарных файлов:

```bash
# Сгенерировать набор бинарных файлов разных размеров (1KB, 10KB, 100KB, 1MB)
go run scripts/generate_binary_file.go
```

Файлы будут созданы в папке `test_files/`.

## Установка и запуск

### Предварительные требования

- Go 1.21 или выше

### Установка зависимостей

```bash
go mod tidy
```

### Запуск сервера

```bash
go run main.go -mode=server -port=8080
```

Сервер будет доступен по адресу `http://localhost:8080`

### Запуск клиента

```bash
go run main.go -mode=client -file=/path/to/your/file -url=http://localhost:8080/upload
```

## Параметры командной строки

### Общие параметры

- `-mode`: Режим работы (`client` или `server`)
- `-port`: Порт для сервера (по умолчанию: 8080)

### Параметры клиента

- `-file`: Путь к файлу для загрузки (обязательный)
- `-url`: URL сервера для загрузки (по умолчанию: http://localhost:8080/upload)
- `-timeout`: Таймаут для HTTP-клиента (по умолчанию: 30 минут)

### Примеры использования

```bash
# Запуск сервера на порту 9000
go run main.go -mode=server -port=9000

# Загрузка файла с кастомным таймаутом
go run main.go -mode=client -file=test_files/binary_1MB.bin -timeout=1h

# Загрузка файла на удаленный сервер
go run main.go -mode=client -file=test_files/binary_10KB.bin -url=https://example.com/upload
```

## Тестирование

### Запуск всех тестов

```bash
go test ./...
```

### Запуск тестов с покрытием

```bash
go test -cover ./...
```

### Запуск бенчмарков

```bash
go test -bench=. ./client/
```

### Запуск конкретного теста

```bash
go test -run TestUploadFile_Success ./client/
```

## Примеры работы

### Запуск сервера

```bash
$ go run main.go -mode=server -port=8080
Сервер запущен на порту 8080
Для загрузки файлов используйте: http://localhost:8080/upload
```

### Загрузка файла

```bash
$ go run main.go -mode=client -file=test_files/binary_1MB.bin
Начинаем загрузку файла: test_files/binary_1MB.bin
Сервер: http://localhost:8080/upload
Таймаут: 30m0s

Прогресс: 25.50% (256.0 KB / 1.0 MB)
Прогресс: 50.25% (512.0 KB / 1.0 MB)
Прогресс: 75.75% (768.0 KB / 1.0 MB)
Прогресс: 100.00% (1.0 MB / 1.0 MB)
Загрузка завершена успешно!
```

### Прием файла на сервере

```
Начинаем прием файла: binary_1MB.bin (размер: 1.0 MB)
Прием: 25.50% (256.0 KB / 1.0 MB)
Прием: 50.25% (512.0 KB / 1.0 MB)
Прием: 75.75% (768.0 KB / 1.0 MB)
Прием: 100.00% (1.0 MB / 1.0 MB)
Файл binary_1MB.bin успешно сохранен в uploads/binary_1MB.bin
Общий размер принятых данных: 1.0 MB
```

## Архитектура

### HTTP-клиент

- Использует `io.Pipe()` для потоковой передачи данных
- Читает файл по частям (64KB буфер)
- Поддерживает отмену через контекст
- Отображает прогресс передачи в реальном времени

### HTTP-сервер

- Принимает multipart/form-data запросы
- Сохраняет файлы в директорию `uploads/`
- Отображает прогресс приема
- Обрабатывает ошибки и возвращает соответствующие HTTP-статусы

## Обработка ошибок

Клиент обрабатывает следующие типы ошибок:

- Файл не найден
- Файл пустой
- Ошибки сети
- Ошибки сервера (HTTP-статусы)
- Таймауты
- Отмена контекста

Все ошибки выводятся на русском языке с подробным описанием.

## Производительность

- Оптимизирован для передачи больших файлов
- Минимальное использование памяти
- Эффективная буферизация
- Поддержка параллельных загрузок

## Оптимизация для высоких нагрузок

### Конфигурируемые параметры

Клиент поддерживает настройку для оптимизации под различные нагрузки:

```go
config := &client.ClientConfig{
    BufferSize:     256 * 1024, // Размер буфера (по умолчанию: 64KB)
    MaxConcurrency: 8,          // Максимум параллельных загрузок
    Timeout:        60 * time.Minute,
    RetryAttempts:  5,          // Количество попыток при ошибке
    RetryDelay:     2 * time.Second,
}

httpClient := client.NewHTTPClientWithConfig(config)
```

### Рекомендации по настройке

#### Для больших файлов (>1GB):
- `BufferSize`: 512KB - 1MB
- `MaxConcurrency`: 2-4 (меньше параллелизма для экономии памяти)
- `Timeout`: 120+ минут

#### Для множества маленьких файлов:
- `BufferSize`: 64KB - 256KB
- `MaxConcurrency`: 8-16 (больше параллелизма)
- `Timeout`: 30-60 минут

#### Для высокоскоростных сетей:
- `BufferSize`: 1MB - 2MB
- `MaxConcurrency`: 4-8
- `RetryAttempts`: 3-5

### Параллельная загрузка

```go
// Загрузка нескольких файлов параллельно
files := []string{"file1.bin", "file2.bin", "file3.bin"}
err := client.UploadMultipleFiles(ctx, files, serverURL, progressCallback)

// Загрузка всей директории
err := client.UploadDirectory(ctx, "uploads/", serverURL, progressCallback)
```

### Retry механизм

Клиент автоматически повторяет попытки при временных ошибках:
- Сетевые ошибки
- HTTP 5xx ошибки
- Таймауты

Постоянные ошибки (файл не найден, ошибки валидации) не повторяются.

### Мониторинг производительности

Запустите бенчмарки для тестирования производительности:

```bash
# Тест разных размеров буфера
go test -bench=BenchmarkUploadFile ./client/

# Тест параллельных загрузок
go test -bench=BenchmarkParallelUploads ./client/
```

### Пример высокопроизводительного клиента

```bash
# Запуск примера с оптимизированной конфигурацией
go run examples/high_performance_client.go
```
